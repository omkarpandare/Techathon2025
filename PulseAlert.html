<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PulseAlert | Seismic Intelligence Dashboard</title>
  <meta name="description" content="Unified earthquake alerting, global seismic map, analytics, and logbook in a single high-performance dashboard." />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <style>
    :root{
      --bg-1:#05060f;
      --bg-2:#0b0f28;
      --glass:#0e1530cc;
      --glass-2:#0b122bcc;
      --stroke:#1f2a44;
      --card:#0d1a3a;
      --text:#e8f0ff;
      --muted:#a7b4d6;
      --neon:#7cddff;
      --neon-2:#ff6b6b;
      --accent:#7c5cff;
      --good:#36d399;
      --warn:#ffd166;
      --danger:#ff4d4d;
      --shadow: 0 20px 60px rgba(0,0,0,.45), 0 0 80px rgba(124,93,255,.15);
      --radius:16px;
    }

    body.light-theme{
      :root {
  --bg-1: #ffffff;            /* main background */
  --bg-2: #f5f7fa;            /* soft secondary background */
  --glass: rgba(255, 255, 255, 0.7);   /* frosted glass */
  --glass-2: rgba(255, 255, 255, 0.5); /* lighter frosted glass */
  --stroke: #e2e8f0;          /* subtle border/lines */
  --card: #ffffff;            /* card surface */
  --text: #1e293b;            /* dark navy-gray for good readability */
  --muted: #64748b;           /* muted text */
  
  /* Accents */
  --neon: #3b82f6;            /* modern blue */
  --neon-2: #ef4444;          /* soft red */
  --accent: #8b5cf6;          /* purple accent */
  --good: #22c55e;            /* warm yellow */
  --danger: #dc2626;          /* danger red */
  
  /* Shadows */
  --shadow: 0 10px 30px rgba(0, 0, 0, 0.08),
            0 0 40px rgba(59, 130, 246, 0.1);
}

    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, #16204a 0%, transparent 40%),
                  radial-gradient(1200px 800px at 120% 30%, #1c1249 0%, transparent 40%),
                  linear-gradient(160deg, var(--bg-1), var(--bg-2) 60%);
      overflow-x:hidden;
    }

    .glow{
      position:fixed; inset: -20% -20% auto auto; width: 40vmax; height: 40vmax;
      background: radial-gradient(circle at 30% 30%, rgba(124,221,255,.12), transparent 60%),
                  radial-gradient(circle at 70% 70%, rgba(124,93,255,.10), transparent 65%);
      filter: blur(30px);
      pointer-events:none; z-index:0;
      animation: float 16s ease-in-out infinite alternate;
      opacity:.8;
    }
    @keyframes float{to{transform: translate(-8%, -4%) scale(1.05)}}

    header.appbar{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(180deg, rgba(11,15,40,.85), rgba(11,15,40,.4));
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--stroke);
    }
    .appbar-inner{
      max-width:1200px; margin:0 auto; padding:14px 18px;
      display:flex; align-items:center; justify-content:space-between;
      gap:14px;
    }
    .brand{
      display:flex; align-items:center; gap:12px; letter-spacing:.3px;
    }
    .brand-logo{
      width:36px; height:36px; border-radius:10px;
      background:
        radial-gradient(140% 90% at 10% 5%, rgba(124,93,255,.5), transparent 60%),
        linear-gradient(135deg, #0b163a, #1b2a67);
      box-shadow: inset 0 0 18px rgba(124,221,255,.15), 0 0 0 1px rgba(255,255,255,.06);
      position:relative;
      display: grid;
      place-items: center;
      font-size: 22px;
      line-height: 1;
    }
    .brand-logo::after{
      content:""; position:absolute; inset:10% 10% 30% 30%;
      background: conic-gradient(from 140deg, var(--neon), var(--accent), var(--neon-2), var(--neon));
      filter: blur(14px); opacity:.18;
      border-radius:12px;
    }
    .brand h1{
      font-size:18px; margin:0;
    }
    .brand small{
      color:var(--muted);
      font-size:12px;
      display:block;
      margin-top:2px;
    }

    .nav{
      display:flex; gap:8px; flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(15,20,52,.6), rgba(15,20,52,.3));
      border:1px solid var(--stroke);
      padding:6px; border-radius:999px;
      box-shadow: var(--shadow);
    }
    .nav button{
      all:unset; padding:10px 14px; border-radius:999px;
      color:var(--muted); cursor:pointer;
      transition:.2s ease;
    }
    .nav button.active{
      background: linear-gradient(180deg, rgba(124,221,255,.18), rgba(124,221,255,.06));
      color:var(--text);
      box-shadow: inset 0 0 0 1px rgba(124,221,255,.35), 0 6px 20px rgba(124,221,255,.16);
      text-shadow: 0 0 18px rgba(124,221,255,.25);
    }

    .toolbar{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    }
    .btn{
      all:unset; background: linear-gradient(180deg, rgba(124,93,255,.35), rgba(124,93,255,.15));
      padding:10px 14px; border-radius:12px; cursor:pointer;
      border:1px solid rgba(124,93,255,.5);
      box-shadow: 0 8px 24px rgba(124,93,255,.25);
      transition:.2s ease; font-weight:600;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.secondary{
      background: linear-gradient(180deg, rgba(124,221,255,.25), rgba(124,221,255,.08));
      border-color: rgba(124,221,255,.45);
      box-shadow: 0 8px 24px rgba(124,221,255,.2);
    }

    main{ position:relative; z-index:1; }
    .container{ max-width:1200px; margin:24px auto; padding:0 18px; }

    .grid{
      display:grid; gap:18px;
      grid-template-columns: 1.4fr 1fr;
    }
    @media (max-width: 1100px){
      .grid{ grid-template-columns:1fr; }
    }

    .panel{
      background: linear-gradient(180deg, var(--glass), var(--glass-2));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px; border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
    }
    .panel-body{ padding:16px; }

    /* Alerts */
    .alerts{ display:flex; flex-direction:column; gap:12px; }
    .alert{
      display:grid; align-items:center;
      grid-template-columns:auto 1fr auto auto;
      gap:14px; padding:12px 14px; border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);
      cursor:pointer; transition:.2s;
    }
    .alert:hover{ transform: translateY(-2px); border-color: rgba(124,221,255,.35); }
    .alert .icon{
      width:38px; height:38px; display:grid; place-items:center; border-radius:10px;
      background: radial-gradient(120% 120% at 20% 10%, rgba(255,109,109,.35), rgba(255,109,109,.08));
      border:1px solid rgba(255,109,109,.5);
      text-shadow: 0 0 14px rgba(255,109,109,.4);
    }
    .alert .loc{ font-weight:700; }
    .alert .region{ color:var(--muted); font-size:12px; }
    .alert .mag{
      font-weight:800; color:var(--danger);
      text-shadow: 0 0 18px rgba(255,77,77,.4);
      min-width:80px; text-align:right;
    }
    .alert .time{ color:var(--muted); font-size:12px; white-space:nowrap; }

    /* Map + Right analytics */
    #map{ height:480px; background:#0a132f; border-radius: 12px; overflow:hidden; border:1px solid var(--stroke); }
    .legend{
      background: rgba(12,20,45,.9);
      color:var(--text);
      border:1px solid var(--stroke);
      padding:10px 12px;
      border-radius:10px;
      font-size:12px;
      line-height:1.2;
    }
    .legend .scale{ height:12px; border-radius:8px; margin:6px 0 4px; background: linear-gradient(90deg, #ffdede 0%, #ff4d4d 100%); }
    .infopanel{
      position:relative;
    }
    .slide-info{
      position:absolute; right:0; top:0; width:100%; max-width:320px;
      transform: translateX(115%); transition:.35s ease;
      background: linear-gradient(180deg, rgba(14,21,48,.95), rgba(14,21,48,.85));
      border:1px solid var(--stroke); border-radius:12px; padding:14px;
      box-shadow: var(--shadow);
    }
    .slide-info.visible{ transform: translateX(0%); }

    .statbar{
      display:grid; grid-template-columns: repeat(3,1fr); gap:12px;
    }
    .stat{
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px; padding:12px;
      text-align:center;
    }
    .stat .v{ font-size:28px; font-weight:800; color:var(--neon); text-shadow:0 0 18px rgba(124,221,255,.35); }
    .stat .l{ color:var(--muted); font-size:12px; }

    /* Charts */
    .charts{
      display:grid; gap:12px;
      grid-template-columns:1fr;
    }
    .chartcard{
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px; padding:12px;
    }
    .chartcard h4{ margin:0 0 10px; color:var(--neon-2) }

    canvas{ width:100% !important; height:300px !important; }

    /* Logbook */
    .filters{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .pill{
      all:unset; cursor:pointer; padding:10px 12px; border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);
      color:var(--muted); font-weight:600;
    }
    .pill.active{
      color:var(--text);
      background: linear-gradient(180deg, rgba(124,221,255,.2), rgba(124,221,255,.06));
      border:1px solid rgba(124,221,255,.45);
      text-shadow:0 0 16px rgba(124,221,255,.35);
      box-shadow: 0 8px 24px rgba(124,221,255,.2);
    }
    .cards{
      margin-top:12px;
      display:grid; gap:12px;
      grid-template-columns: repeat( auto-fit, minmax(260px, 1fr) );
    }
    .card{
      padding:12px; border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.005));
      border:1px solid rgba(255,255,255,.06);
      transition:.25s ease; position:relative; overflow:hidden;
    }
    .card:hover{ transform: translateY(-2px); border-color: rgba(124,221,255,.35); }
    .mag{
      font-size:22px; font-weight:900;
    }
    .mag.critical{ color:var(--danger) }
    .mag.high{ color: #ffb02e }
    .mag.medium{ color:#ffd166 }
    .location{
      margin-top:4px; font-weight:700;
    }
    .details{
      margin-top:8px; display:grid; grid-template-columns: repeat(2,1fr); gap:8px; font-size:12px;
    }
    .badge{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:11px; border:1px solid rgba(255,255,255,.12); color:var(--muted) }

    /* Sections toggle */
    .section{ display:none; }
    .section.active{ display:block; }

    /* Modals */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(6px);
      display:none; z-index:99;
    }
    .overlay.visible{ display:block }

    .modal{
      position:fixed; inset:auto 0 0 0; top:50%; transform: translateY(-50%);
      margin-inline:auto; width:min(680px, 92vw); z-index:100;
      background: linear-gradient(180deg, rgba(12,19,48,.98), rgba(12,19,48,.9));
      border:1px solid var(--stroke); border-radius: 18px;
      box-shadow: var(--shadow); padding:16px; display:none;
    }
    .modal.visible{ display:block }

    /* SOS floating */
    .sos{
      position:fixed; right:18px; bottom:18px; z-index:40;
      display:flex; align-items:center; gap:10px;
      padding:14px 18px; border-radius:999px; font-weight:900;
      color:#fff; text-shadow: 0 0 16px rgba(255,77,77,.55);
      background: radial-gradient(120% 200% at 20% 20%, rgba(255,77,77,.55), rgba(255,77,77,.25)) , linear-gradient(180deg, rgba(255,77,77,.28), rgba(255,77,77,.18));
      border:1px solid rgba(255,77,77,.55);
      box-shadow: 0 16px 40px rgba(255,77,77,.35), inset 0 0 0 1px rgba(255,255,255,.06);
      cursor:pointer;
      transition:.25s ease;
    }
    .sos:hover{ transform: translateY(-2px) scale(1.02) }

    .disclaimer{
      margin-top:14px; color:var(--muted); font-size:12px;
    }

    a.inline{ color:var(--neon); text-decoration:none; border-bottom:1px dashed rgba(124,221,255,.35) }
    a.inline:hover{ opacity:.85 }
  </style>
</head>
<body>
  <div class="glow" aria-hidden="true"></div>
  <header class="appbar">
    <div class="appbar-inner">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true">🇮🇳</div>
        <div>
          <h1>PulseAlert</h1>
          <small>Seismic Intelligence Dashboard</small>
        </div>
      </div>

      <nav class="nav" role="tablist" aria-label="Sections">
        <button class="active" data-target="alerts" role="tab" aria-selected="true">Alerts</button>
        <button data-target="map" role="tab" aria-selected="false">Map + Analytics</button>
        <button data-target="logbook" role="tab" aria-selected="false">Logbook</button>
      </nav>

      <div class="toolbar">
        <button class="btn secondary" id="refreshBtn">↻ Refresh</button>
        <button class="btn" id="themeBtn">✨ Theme</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Alerts Section -->
    <section id="section-alerts" class="section active">
      <div class="grid">
        <div class="panel">
          <div class="panel-header">
            <div><strong>India Earthquake Alerts</strong> <span class="badge">Auto-updates every 5 min</span></div>
            <div class="badge">Region filter: 5–40°N, 60–105°E</div>
          </div>
          <div class="panel-body">
            <div id="alerts" class="alerts">
              <p style="text-align:center;color:var(--muted)">Loading alerts...</p>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <strong>Preparedness & Immediate Actions</strong>
            <span class="badge">Safety</span>
          </div>
          <div class="panel-body">
            <ul style="margin:0 0 10px 18px">
              <li>Drop, Cover, and Hold On. Stay away from windows and heavy objects.</li>
              <li>If outdoors, move to open ground; if driving, pull over and stay in vehicle.</li>
              <li>Check for gas leaks, damaged wiring, and structural risks post-event.</li>
              <li>Follow official advisories. Avoid elevators.</li>
            </ul>
            <div class="disclaimer">Data: USGS public feeds. Times are local to your device.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Map + Analytics Section -->
    <section id="section-map" class="section">
      <div class="grid">
        <div class="panel" style="position:relative">
          <div class="panel-header">
            <strong>Global Seismic Map</strong>
            <span class="badge">USGS All Week</span>
          </div>
          <div class="panel-body infopanel">
            <div id="map"></div>
            <div id="infoPanel" class="slide-info" aria-live="polite">
              <h3 style="margin-top:0;color:var(--neon)">Seismic Datastream</h3>
              <div><strong>Place:</strong> <span id="info-place">-</span></div>
              <div><strong>Magnitude:</strong> <span id="info-mag">-</span></div>
              <div><strong>Depth:</strong> <span id="info-depth">-</span></div>
              <div><strong>Time:</strong> <span id="info-time">-</span></div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <strong>Analytics</strong>
            <span class="badge">Dynamic</span>
          </div>
          <div class="panel-body">
            <div class="statbar" style="margin-bottom:12px">
              <div class="stat">
                <div class="v" id="stat-total">-</div>
                <div class="l">Total (7 days)</div>
              </div>
              <div class="stat">
                <div class="v" id="stat-max">-</div>
                <div class="l">Max Magnitude</div>
              </div>
              <div class="stat">
                <div class="v" id="stat-depth">-</div>
                <div class="l">Avg Depth (km)</div>
              </div>
            </div>

            <div class="charts">
              <div class="chartcard">
                <h4>Magnitude Distribution</h4>
                <canvas id="chart-mag"></canvas>
              </div>
              <div class="chartcard">
                <h4>Depth Bins</h4>
                <canvas id="chart-depth"></canvas>
              </div>
              <div class="chartcard">
                <h4>Temporal Activity (last 7 days)</h4>
                <canvas id="chart-time"></canvas>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- Logbook Section -->
    <section id="section-logbook" class="section">
      <div class="panel">
        <div class="panel-header">
          <strong>Seismic Logbook</strong>
          <div class="filters" role="group" aria-label="Magnitude filter">
            <button class="pill active" data-mag="all">All</button>
            <button class="pill" data-mag="4">4.0+</button>
            <button class="pill" data-mag="5">5.0+</button>
            <button class="pill" data-mag="6">6.0+</button>
          </div>
        </div>
        <div class="panel-body">
          <div id="cards" class="cards">
            <p style="text-align:center;color:var(--muted);grid-column:1/-1">Loading logbook...</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Floating SOS -->
  <button class="sos" id="sosBtn">🆘 Emergency SOS</button>

  <!-- Overlays / Modals -->
  <div id="overlay" class="overlay" aria-hidden="true"></div>

  <div id="modal-alert" class="modal" role="dialog" aria-modal="true" aria-labelledby="alertModalTitle">
    <div id="modal-alert-content">
      <h3 id="alertModalTitle" style="margin:0 0 8px;color:var(--neon-2)">Alert</h3>
      <div id="alert-details" style="color:var(--text)"></div>
      <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end">
        <button class="btn secondary" data-close>Close</button>
      </div>
    </div>
  </div>

  <div id="modal-sos" class="modal" role="dialog" aria-modal="true" aria-labelledby="sosModalTitle">
    <h3 id="sosModalTitle" style="margin:0 0 8px;color:#ffb3b3;">Emergency Contacts (India)</h3>
    <div class="panel-body" style="padding:0">
      <div class="alert" style="cursor:default">
        <div class="icon">🚑</div>
        <div>
          <div class="loc">National Emergency Number</div>
          <div class="region">112 / 100</div>
        </div>
      </div>
      <div class="alert" style="cursor:default">
        <div class="icon">🛰️</div>
        <div>
          <div class="loc">Disaster Management Helpline</div>
          <div class="region">1078</div>
        </div>
      </div>
      <div class="alert" style="cursor:default">
        <div class="icon">🏥</div>
        <div>
          <div class="loc">NDRF Control Room</div>
          <div class="region">+91-11-24363260</div>
        </div>
      </div>
      <div class="alert" style="cursor:default">
        <div class="icon">👩‍⚕️</div>
        <div>
          <div class="loc">Women's Helpline</div>
          <div class="region">1091 / 112</div>
        </div>
      </div>
    </div>
    <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end">
      <button class="btn secondary" data-close>Close</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Utility
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const esc = (str) => {
      const p = document.createElement('p'); p.textContent = String(str ?? ""); return p.innerHTML;
    };

    const state = {
      earthquakes: [],
      indiaAlerts: [],
      minMagFilter: 0,
      charts: { mag: null, depth: null, time: null },
      map: null,      markersLayer: null,
      infoPanel: null,
      autoTimer: null,
      themeDark: true
    };

    const ENDPOINT_GLOBAL = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_week.geojson";

    // Regions helper (India bounding)
    function isIndiaRegion(lat, lon){
      return (lat >= 5 && lat <= 40 && lon >= 60 && lon <= 105);
    }

    function toLocal(ts){ try { return new Date(ts).toLocaleString(); } catch { return "-"; } }

    function computeIndiaAlertsFromGlobal(features){
      const now = Date.now();
      const twoDaysMs = 2 * 24 * 60 * 60 * 1000;
      const alerts = [];
      for(const f of features){
        const [lon, lat, depth] = f.geometry?.coordinates || [];
        const t = f.properties?.time;
        if(lat == null || lon == null || t == null) continue;
        if(!isIndiaRegion(lat, lon)) continue;
        if(now - t > twoDaysMs) continue; // recent within ~2 days
        alerts.push({
          id: f.id,
          location: f.properties.place,
          magnitude: f.properties.mag ?? 0,
          time: t,
          depth: depth ?? 0,
          coordinates: {lat, lon}
        });
      }
      alerts.sort((a,b) => (b.magnitude ?? 0) - (a.magnitude ?? 0));
      return alerts;
    }

    async function fetchGlobal(){
      const res = await fetch(ENDPOINT_GLOBAL);
      if(!res.ok) throw new Error("USGS feed error: " + res.status);
      const data = await res.json();
      return data?.features || [];
    }

    function setSection(target){
      $$(".nav button").forEach(b=>{
        const active = b.dataset.target === target;
        b.classList.toggle("active", active);
        b.setAttribute("aria-selected", String(active));
      });
      $$(".section").forEach(sec => sec.classList.remove("active"));
      $("#section-"+target).classList.add("active");
      if(target === "map"){
        setTimeout(()=>{ if(state.map){ state.map.invalidateSize(); } }, 120);
      }
    }

    function renderAlerts(list){
      const root = $("#alerts");
      if(!list || list.length === 0){
        root.innerHTML = '<p style="text-align:center;color:var(--muted)">No recent India-region events. Showing sample.</p>';
        // sample fallbacks
        list = [
          {id:"m1", location:"Himalayan Region (Sample)", magnitude:4.8, time: Date.now()-3600e3, depth:12, coordinates:{lat:30.73, lon:79.07}},
          {id:"m2", location:"Western India (Sample)", magnitude:3.9, time: Date.now()-2*3600e3, depth:8, coordinates:{lat:23.25, lon:72.62}}
        ];
      } else {
        root.innerHTML = "";
      }

      root.innerHTML = list.map(a => `
        <article class="alert" data-alert-id="${esc(a.id)}">
          <div class="icon">🌋</div>
          <div>
            <div class="loc">${esc(a.location)}</div>
            <div class="region">${esc(regionName(a.coordinates.lat, a.coordinates.lon))}</div>
          </div>
          <div class="mag">M ${Number(a.magnitude ?? 0).toFixed(1)}</div>
          <div class="time">${esc(toLocal(a.time))}</div>
        </article>
      `).join("");

      // click detail
      root.addEventListener("click", (e)=>{
        const el = e.target.closest(".alert");
        if(!el) return;
        const id = el.dataset.alertId;
        const a = list.find(x=> String(x.id) === String(id));
        if(a) openAlertModal(a);
      }, { once: true }); // attach once (we re-render on refresh)
    }

    function openAlertModal(a){
      const box = $("#modal-alert");
      const body = $("#alert-details");
      body.innerHTML = `
        <div class="badge" style="margin-bottom:8px">${a.magnitude > 5 ? "RED ALERT" : "YELLOW ALERT"}</div>
        <p><strong>Location:</strong> ${esc(a.location)}</p>
        <p><strong>Magnitude:</strong> M ${Number(a.magnitude ?? 0).toFixed(1)}</p>
        <p><strong>Depth:</strong> ${Number(a.depth ?? 0).toFixed(1)} km</p>
        <p><strong>Time:</strong> ${esc(toLocal(a.time))}</p>
        <p><strong>Coordinates:</strong>
          <a class="inline" target="_blank" rel="noopener noreferrer"
             href="https://maps.google.com/?q=${a.coordinates.lat},${a.coordinates.lon}">
             ${a.coordinates.lat.toFixed(2)}°N, ${a.coordinates.lon.toFixed(2)}°E
          </a>
        </p>
      `;
      showModal(box);
    }

    function regionName(lat, lon){
      if(lat > 28) return "Northern India";
      if(lat < 20) return "Southern India";
      if(lon < 75) return "Western India";
      return "Eastern India";
    }

    // Map
    function initMap(){
      if(state.map) return;
      state.map = L.map('map', { zoomControl:false, attributionControl:false }).setView([20, 0], 2);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(state.map);
      state.markersLayer = L.layerGroup().addTo(state.map);

      const legend = L.control({position:'bottomright'});
      legend.onAdd = () => {
        const div = L.DomUtil.create('div','legend');
        div.innerHTML = `
          <div style="font-weight:800; margin-bottom:4px">SEISMIC LEGEND</div>
          <div class="scale"></div>
          <div style="display:flex; justify-content:space-between; color:#ffadad">
            <span>Low</span><span>High</span>
          </div>
          <div style="margin-top:6px">
            <div><strong>Size:</strong> Magnitude power</div>
            <div><strong>Color:</strong> Intensity</div>
          </div>`;
        return div;
      };
      legend.addTo(state.map);

      document.addEventListener("click", (e)=>{
        if(!e.target.closest(".slide-info") && !e.target.closest(".leaflet-interactive")){
          $("#infoPanel").classList.remove("visible");
        }
      });
    }

    function colorForMag(m, maxMag){
      const light = 80 - (m / (maxMag||8) * 60);
      const L = Math.min(80, Math.max(20, light));
      return `hsl(0, 100%, ${L}%)`;
    }

    function renderMap(features){
      initMap();
      state.markersLayer.clearLayers();

      if(!features || features.length === 0){
        $("#map").innerHTML = '<h2 style="text-align:center;padding-top:2rem;color:#ffb3b3;">No seismic data.</h2>';
        return;
      }

      const mags = features.map(f=> f.properties?.mag).filter(x=> x!=null);
      const maxMag = mags.length ? Math.max(...mags) : 8;

      for(const f of features){
        const coords = f.geometry?.coordinates || [];
        const [lon, lat, depth] = coords;
        const p = f.properties || {};
        if(lat==null || lon==null) continue;
        const color = colorForMag(p.mag ?? 0, maxMag);

        const marker = L.circleMarker([lat, lon], {
          radius: Math.max(2, Math.pow(p.mag||0, 1.5) * 0.5),
          fillColor: color,
          color: 'rgba(255,255,255,.35)',
          weight: 1,
          opacity: .85,
          fillOpacity: .7
        }).addTo(state.markersLayer);

        marker.bindPopup(`
          <div style="min-width:220px;color:#2a363b">
            <h3 style="margin:.2rem 0;color:#d33"> ${esc(p.place)} </h3>
            <div style="display:grid;grid-template-columns:90px 1fr;gap:6px;font-size:.92rem">
              <div style="color:#5a7184;font-weight:700">MAGNITUDE</div><div>${esc(p.mag)}</div>
              <div style="color:#5a7184;font-weight:700">DEPTH</div><div>${Number(depth ?? 0).toFixed(1)} km</div>
              <div style="color:#5a7184;font-weight:700">TIME</div><div>${esc(toLocal(p.time))}</div>
            </div>
          </div>
        `);

        marker.on('click', ()=>{
          $("#info-place").textContent = p.place || "-";
          $("#info-mag").textContent = p.mag ?? "-";
          $("#info-depth").textContent = (depth!=null? depth.toFixed(1) : "-") + " km";
          $("#info-time").textContent = toLocal(p.time);
          $("#infoPanel").classList.add("visible");
        });
      }
    }

    // Charts
    function destroyCharts(){
      Object.values(state.charts).forEach(c => { try{c?.destroy()}catch{} });
      state.charts = {mag:null, depth:null, time:null};
    }
    function renderCharts(features){
      destroyCharts();
      const mags = features.map(f=>f.properties?.mag).filter(m => m!=null);
      const depths = features.map(f=>f.geometry?.coordinates?.[2]).filter(d => d!=null);

      // Magnitude distribution
      const magBins = {};
      mags.forEach(m => {
        const bin = Math.floor(m);
        magBins[bin] = (magBins[bin] || 0) + 1;
      });
      state.charts.mag = new Chart($("#chart-mag"), {
        type: 'pie',
        data: {
          labels: Object.keys(magBins).map(b => `Mag ${b}`),
          datasets: [{
            data: Object.values(magBins),
            backgroundColor: ['#ff4444', '#ff6b6b', '#ff8f8f', '#ffb3b3', '#ffd7d7'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right', labels: { color: '#f4ede4', font: { size: 12 } } }
          }
        }
      });

      // Depth bins
      const depthBins = { '0-10': 0, '10-30': 0, '30-50': 0, '50-100': 0, '100-300': 0, '300+': 0 };
      depths.forEach(d => {
        if (d <= 10) depthBins['0-10']++;
        else if (d <= 30) depthBins['10-30']++;
        else if (d <= 50) depthBins['30-50']++;
        else if (d <= 100) depthBins['50-100']++;
        else if (d <= 300) depthBins['100-300']++;
        else depthBins['300+']++;
      });
      state.charts.depth = new Chart($("#chart-depth"), {
        type: 'bar',
        data: {
          labels: Object.keys(depthBins),
          datasets: [{
            label: 'Earthquakes',
            data: Object.values(depthBins),
            backgroundColor: '#ff4444',
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { ticks: { color: '#f4ede4' }, grid: { color: 'rgba(244,237,228,0.1)' } },
            x: { ticks: { color: '#f4ede4', autoSkip: true, maxRotation: 0 }, grid: { color: 'rgba(244,237,228,0.1)' } }
          }
        }
      });

      // Temporal activity
      const timeData = {};
      features.forEach(f => {
        const date = new Date(f.properties?.time).toISOString().split('T')[0];
        timeData[date] = (timeData[date] || 0) + 1;
      });
      state.charts.time = new Chart($("#chart-time"), {
        type: 'line',
        data: {
          labels: Object.keys(timeData),
          datasets: [{
            label: 'Seismic Events',
            data: Object.values(timeData),
            borderColor: '#ff4444',
            tension: 0.4,
            borderWidth: 2,
            pointRadius: 3,
            pointBackgroundColor: '#f4ede4'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { ticks: { color: '#f4ede4' }, grid: { color: 'rgba(244,237,228,0.1)' } },
            x: { ticks: { color: '#f4ede4', autoSkip: true, maxRotation: 0 }, grid: { color: 'rgba(244,237,228,0.1)' } }
          }
        }
      });
    }

    // Stats
    function renderStats(features){
      const total = features.length;
      const mags = features.map(f=>f.properties?.mag).filter(m=>m!=null);
      const depths = features.map(f=>f.geometry?.coordinates?.[2]).filter(d=>d!=null);

      $("#stat-total").textContent = total;
      $("#stat-max").textContent = mags.length ? Math.max(...mags).toFixed(1) : '-';
      $("#stat-depth").textContent = depths.length ? (depths.reduce((a,b)=>a+b,0)/depths.length).toFixed(1) : '-';
    }

    // Logbook
    function renderLogbook(features){
      const root = $("#cards");
      const filtered = features.filter(f => (f.properties?.mag ?? 0) >= state.minMagFilter);

      if(!filtered || filtered.length === 0){
        root.innerHTML = '<p style="text-align:center;color:var(--muted);grid-column:1/-1">No earthquakes match the current filter.</p>';
        return;
      }

      root.innerHTML = filtered.map(f => {
        const p = f.properties || {};
        const coords = f.geometry?.coordinates || [];
        const mag = p.mag ?? 0;
        const magClass = mag >= 6 ? 'critical' : mag >= 5 ? 'high' : mag >= 4 ? 'medium' : '';
        return `
          <div class="card">
            <div class="mag ${magClass}">M ${mag.toFixed(1)}</div>
            <div class="location">${esc(p.place)}</div>
            <div class="details">
              <div><strong>Depth:</strong> ${Number(coords[2] ?? 0).toFixed(1)} km</div>
              <div><strong>Status:</strong> ${esc(p.status || 'Unknown')}</div>
              <div><strong>Tsunami:</strong> ${p.tsunami ? '🌊 Possible' : '❌ Unlikely'}</div>
              <div><strong>More Info:</strong> <a href="${esc(p.url)}" target="_blank" rel="noopener noreferrer">USGS</a></div>
            </div>
            <div style="margin-top:8px;color:var(--muted);font-size:11px">${esc(toLocal(p.time))}</div>
          </div>
        `;
      }).join("");
    }

    function getMagnitudeClass(mag){
      if(mag >= 6) return 'critical';
      if(mag >= 5) return 'high';
      if(mag >= 4) return 'medium';
      return '';
    }

    // Modals
    function showModal(modal){
      $("#overlay").classList.add("visible");
      modal.classList.add("visible");
    }

    function hideModals(){
      $("#overlay").classList.remove("visible");
      $$(".modal").forEach(m => m.classList.remove("visible"));
    }

    // Main load
    async function loadData(){
      try {
        const features = await fetchGlobal();
        state.earthquakes = features;
        state.indiaAlerts = computeIndiaAlertsFromGlobal(features);

        renderAlerts(state.indiaAlerts);
        renderMap(features);
        renderCharts(features);
        renderStats(features);
        renderLogbook(features);
      } catch (error) {
        console.error("Load error:", error);
        // Fallback to sample data
        const sampleFeatures = [
          { properties: { place: "Sample Location", mag: 4.5, time: Date.now(), status: "reviewed", tsunami: false, url: "#" }, geometry: { coordinates: [80, 25, 10] } }
        ];
        state.earthquakes = sampleFeatures;
        state.indiaAlerts = computeIndiaAlertsFromGlobal(sampleFeatures);
        renderAlerts(state.indiaAlerts);
        renderMap(sampleFeatures);
        renderCharts(sampleFeatures);
        renderStats(sampleFeatures);
        renderLogbook(sampleFeatures);
      }
    }

    // Event handlers
    function setupEventHandlers(){
      // Navigation
      $$(".nav button").forEach(btn => {
        btn.addEventListener("click", () => setSection(btn.dataset.target));
      });

      // Refresh
      $("#refreshBtn").addEventListener("click", loadData);

      // Theme toggle (placeholder)
      $("#themeBtn").addEventListener("click", () => {
        state.themeDark = !state.themeDark;
        document.body.classList.toggle("light-theme", !state.themeDark);
      });

      // Filters
      $$(".filters .pill").forEach(pill => {
        pill.addEventListener("click", () => {
          $$(".filters .pill").forEach(p => p.classList.remove("active"));
          pill.classList.add("active");
          state.minMagFilter = pill.dataset.mag === "all" ? 0 : parseFloat(pill.dataset.mag) || 0;
          renderLogbook(state.earthquakes);
        });
      });
    }

    // Auto refresh
    function startAutoRefresh(){
      if(state.autoTimer) clearInterval(state.autoTimer);
      state.autoTimer = setInterval(loadData, 5 * 60 * 1000); // 5 minutes
    }

    // Init
    document.addEventListener("DOMContentLoaded", () => {
      setupEventHandlers();
      loadData();
      startAutoRefresh();
    });
  </script>
</body>
</html>
